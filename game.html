<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<head>

    <title>Little Battle</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="style/main.css" rel="stylesheet">
    <link href="style/repo.css" rel="stylesheet">
    <link href="style/game.css" rel="stylesheet">

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/ace/1.2.6/ace.js"></script>
    <script src="lib/jquery.scrollex.min.js"></script>
    <script src="lib/jquery.scrolly.min.js"></script>
    <script src="lib/skel.min.js"></script>
    <script src="lib/util.js"></script>
    <script src="lib/main.js"></script>
    <script src="lib/quisus.js"></script>
    <script src="core.js"></script>
    <script src="renderer.js"></script>
        
</head>

  <body>
    <div class="weapon">
    <img id="UMP9" src="img/UMP9.png"/>
  <img id="Micro_Uzi" src="img/Micro_Uzi.png"/>
  <img id="Vector" src="img/Vector.png"/>
  <img id="AKM" src="img/AKM.png"/>
  <img id="Groza" src="img/Groza.png"/>
  <img id="M16A4" src="img/M16A4.png"/>
  <img id="Scar-L" src="img/Scar-L.png"/>
  <img id="M416" src="img/M416.png"/>
  <img id="Kar-98K" src="img/Kar-98K.png"/>
  <img id="M24" src="img/M24.png"/>
  <img id="SKS" src="img/SKS.png"/>
  <img id="AWM" src="img/AWM.png"/>
  <img id="MK14" src="img/MK14.png"/>
  <img id="M249" src="img/M249.png"/>
  <img id="Minigun" src="img/Minigun.png"/>
  <img id="Dominator-77" src="img/Dominator-77.png"/>
  <img id="PF-89" src="img/PF-89.png"/>
  <img id="S1897" src="img/S1897.png"/>
  <img id="S686" src="img/S686.png"/>
  <img id="Pan" src="img/Pan.png"/>
  <img id="Grenade" src="img/Grenade.png"/>
  <img id="DeathGrenade" src="img/DeathGrenade.png"/>
  <img id="Seeker" src="img/Seeker.png"/>
</div>

    <div class="gameover">
        <div id="msgbox" class="gameover_panel" onclick="$('.gameover').hide(); restart();">
            <ul id="listboard">
            </ul>
        </div>
    </div>
        <!-- Page Wrapper -->
            <div id="page-wrapper">

                <!-- Header -->
                    <header id="header">
                       <h1><a href="index.html">Little Battle</a></h1>
                        <nav id="nav">
                            <ul>
                                <li class="special">
                                    <a href="#menu" class="menuToggle"><span>MENU</span></a>
                                    <div id="menu">
                                        <ul>
                                            <li><a href="index.html">HOME</a></li>
                                            <li><a href="login.html">SIGN IN</a></li>
                                            <li><a href="signup.html">SIGN UP</a></li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </nav>
                    </header>
                </div>
                <div class="left_body">
                        <div id="repo">
                                        <ul id="repo_list">
                                            <li><span>ID</span><span>K/D</span><span>RATE</span></li>

                                        </ul>
                                    </div>                
                        <ul>
                            <li id="controlBtn" class="button info fit">START</li>
                            <li id="clearBtn" class="button info fit">CLEAR</li>
                            <a id="repoBtn" href="#repo" class="button info fit">ADD</a>
                        </ul>
                        <div id="editor">
/* ----以下为注释，删去不影响代码-------
1.流程：

    游戏某一帧开始-->检测事件是否触发-->触发事件，执行玩家代码-->引擎计算速度和位置，发射子弹-->该帧结束

2.可以被调用的方法：
    射击：this.fire() 

    向上移动 ：this.moveUp(pri)
    向下移动 : this.moveDown(pri)
    向左移动 : this.moveLeft(pri)
    向右移动 : this.moveRight(pri)

    ！需要注意的是，如果想一直保持向右移动，需要在每一帧触发的事件中均调用this.moveRight()
    ！pri为可选参数，表示优先级，取值0-5，优先级高的移动会优先执行并屏蔽优先级低的移动，
    ！若不带参数，默认为0。

3.可以获得的属性
    
    当前帧所处的x坐标：this.x
    当前帧所处的y坐标：this.y
    当前炮口方向（以弧度为单位，x轴为0度)：this.dir
    当前速度x分量：this.speed.x
    当前速度y分量：this.speed.y

    ！注意，可以获得表示可以参与计算，如果尝试修改它的值，将不会对游戏产生任何影响
    ！游戏的x轴为正常的从左至右
    ！游戏的y轴为从上至下

4.可以直接修改的属性

    当前炮口方向：this.dir

    ！this.dir既可以直接获得也可以修改，即可以通过修改该属性直接设置游戏中炮口的方向

5.编程时注意

    语法需要遵循JavaScript规范，若出现语法错误，会导致比赛无法进行。
    你可以自定义一些变量辅助计算，甚至定义一些函数，
    但请保证代码开始时的语句"var tank = {"和最后的大括号不变，否则无法被加入比赛。

    JavaScript中的数字没有整数和小数之分，且变量声明无需类型，如声明一个变量a并让其初始值为3：
    
        var a = 3;

    再执行下列代码：

        a = 0.2;
        a = a*a;
        var b= a;

    结果为a = 0.04, b = 0.04。


-------注释结束--------------------*/
var tank = {

        //每帧开始时无条件触发
    onEvent : function() {
        
        /*示例代码1：
            this.fire();
            表示每帧均射击
        */

        /*示例代码2：
            this.moveRight();
            this.moveUp();
            表示一直向右上方移动
        */
    },

        //遇到障碍物时触发，参数dir表示哪一侧有障碍物的方向，
        //例如：dir.u === 1时，代表上方有障碍物，dir.u === 0时即没有障碍物
        //dir.d、dir.l、dir.r依次表示下方、左方、右方，
        //最多三个方向同时有障碍物，最少一个方向
    onHitWall : function(dir) {

        /*示例代码：
            if (dir.u === 1)
                this.moveRight();

            表示若上方有障碍物，则向右移动
        */
    },

        //每帧开始时触发，参数enemies为数组，每个元素代表一个敌方玩家的位置和速度，
        //例如：enemies[0]取值为{ pos:{x:300,y:200}, speed:{x:100,y:0} }
        //表示该玩家在(300,200)处，沿着x轴速度为100，y轴速度为0，
        //若想获得该玩家的位置的x分量，即enemies[0].pos.x，
        //该玩家的速度的y分量，即enemies[0].speed.y。
    onEnemySpotted : function(enemies) {

    }

};

                        </div>       
                                 
                </div>
                <div class="right_body">
                    <canvas id="map"></canvas>
                </div>
            </div>
             

        <script>
            var socket = io.connect();
            if (!localStorage.curUser || localStorage.curUser === "undefined")
                window.location.href = "login.html";

        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.getSession().setMode("ace/mode/javascript");
        editor.setFontSize(14);
        editor.getSession().setOptions({
            tabSize: 4,
            useSoftTabs: true
        });
        editor.getSession().on('change', function(e) {
            window.current_code = editor.getValue();
        });
        </script>

        <script>
            var gameover = function(_stat, _is_failed) {

            let list = document.getElementById("listboard");
            if (_is_failed !== true) {
                let stat = [];
                for (var id in _stat)
                    if (_stat[id] && _stat[id].kill>=0)
                        stat.push([id, _stat[id].kill, _stat[id].death, _stat[id].kill / (_stat[id].death===0 ? 1 : _stat[id].death)]);
                stat.sort((a, b)=>{
                    if (a[3] < b[3])
                        return 1;
                    else if (a[3] > b[3])
                        return -1;
                    else if (a[2] > b[2])
                        return 1;
                    else if (a[2] < b[2])
                        return -1;
                    else if (a[0] > b[0])
                        return 1;
                    else if (a[0] < b[0])
                        return -1;
                    else
                        return 0;
                });

                
                list.innerHTML = "<li><span>Rank</span><span>ID</span><span>K/D</span></li>";

                for (let i = 0; i < stat.length; i++)
                    if (stat[i]!=undefined)
                        list.innerHTML = list.innerHTML + "<li><span>" + (i + 1) + "</span><span>" + stat[i][0] + "</span><span>" + stat[i][1] + "/" + stat[i][2] + "</span></li>";
                socket.emit('update_data', stat);

            }
            else {
                list.innerHTML = "<li>An error ocurred due to " + _stat + "’s fucking code. Competition aborted.</li>";
            }
                $('.gameover').show();   
            };
        </script>



        <script>
        var enviroment = {
                map: document.getElementById('map'),
                ctx: map.getContext('2d')
        };
        core = new Q.core(enviroment,{width:600,height:600},{width:20,height:20},gameover);
        socket.emit("fetch_init_code", localStorage.curUser);
        socket.on('init_code', (code)=>{
            if (code.length > 5)
                editor.setValue(code);
            core.add_player(localStorage.curUser, editor.getValue());
        });
        socket.on('unauthorized', ()=>{
            window.location.href = "login.html";
        });
        
        </script>

    <script>
        $("#repoBtn").on('click', ()=>{
            if (core.competing) {
                alert("中途摇人？不存在的！");
                return;
            }
            let list = document.getElementById('repo_list');
            list.innerHTML = "<li><span>ID</span><span>K/D</span><span>RATE</span></li>";
            if (localStorage.curUser) {
                socket.emit('get_repo');
            }
        });

        socket.on('recv_repo',(results)=>{
            let list = document.getElementById('repo_list');

            for (let i=0; i<results.length; i++)
                results[i].rate = results[i].num_kill / (results[i].num_death === 0 ? 1 : results[i].num_death);
            results.sort((a, b)=>{
                    if (a.rate < b.rate)
                        return 1;
                    else if (a.rate > b.rate)
                        return -1;
                    else if (a.num_death > b.num_death)
                        return 1;
                    else if (a.num_death < b.num_death)
                        return -1;
                    else if (a.id > b.id)
                        return 1;
                    else if (a.id < b.id)
                        return -1;
                    else
                        return 0;
                });

            for (let i=0; i<results.length; i++)
                if (results[i]) {
                    list.innerHTML = list.innerHTML + "<li><span>" +
                        results[i].id + "</span><span>" +
                        results[i].num_kill + "/" +
                        results[i].num_death + "</span><span>" +  results[i].rate.toFixed(1) + "</span><span class='join' id='joinBtn_" + i + "' onclick='socket.emit(&apos;fetch_code&apos;,&apos;"  + results[i].id + "&apos;);'>Join</span></li>";
                }
        });

        socket.on('recv_code', (user)=>{
            core.add_player(user.id, user.code);
        });
    </script>
    <script>
        var controlBtn = document.getElementById("controlBtn");
        var restart = function() {
            window.current_code = editor.getValue();

            core.init(enviroment,{width:600,height:600},{width:20,height:20},gameover);
            core.add_player(localStorage.curUser, window.current_code);

            socket.emit("update_code", {id:localStorage.curUser, code:window.current_code});

            $("#repoBtn").attr("href","#repo");
            controlBtn.innerHTML = "START";
        };
        $("#clearBtn").on('click', restart);
        
        $("#controlBtn").on('click', ()=>{
            if (core.finished) return;
            if (core.running) {
                core.running = false;
                controlBtn.innerHTML = "START";
            }
            else {
                if (core.player_count <= 1) {
                    alert('摇点人吧！一人太孤单了');
                    return;
                }
                core.running = true;
                core.competing = true;
                $("#repoBtn").removeAttr("href");
                controlBtn.innerHTML = "PAUSE";
                socket.emit("update_code", {id:localStorage.curUser, code:window.current_code});        
            }
        });
    </script>

</body>
</html>