<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<head>

    <title>Little Battle</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="style/main.css" rel="stylesheet">
    <link href="style/repo.css" rel="stylesheet">
    <link href="style/game.css" rel="stylesheet">

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/ace/1.2.6/ace.js"></script>
    <script src="lib/jquery.scrollex.min.js"></script>
    <script src="lib/jquery.scrolly.min.js"></script>
    <script src="lib/skel.min.js"></script>
    <script src="lib/util.js"></script>
    <script src="lib/main.js"></script>
    <script src="lib/quisus.js"></script>
    <script src="core.js"></script>
    <script src="renderer.js"></script>
        
</head>

  <body>
    <div class="weapon">
    <img id="UMP9" src="img/UMP9.png"/>
  <img id="Micro_Uzi" src="img/Micro_Uzi.png"/>
  <img id="Vector" src="img/Vector.png"/>
  <img id="AKM" src="img/AKM.png"/>
  <img id="Groza" src="img/Groza.png"/>
  <img id="M16A4" src="img/M16A4.png"/>
  <img id="Scar-L" src="img/Scar-L.png"/>
  <img id="M416" src="img/M416.png"/>
  <img id="Kar-98K" src="img/Kar-98K.png"/>
  <img id="M24" src="img/M24.png"/>
  <img id="SKS" src="img/SKS.png"/>
  <img id="AWM" src="img/AWM.png"/>
  <img id="MK14" src="img/MK14.png"/>
  <img id="M249" src="img/M249.png"/>
  <img id="Minigun" src="img/Minigun.png"/>
  <img id="Dominator-77" src="img/Dominator-77.png"/>
  <img id="PF-89" src="img/PF-89.png"/>
  <img id="S1897" src="img/S1897.png"/>
  <img id="S686" src="img/S686.png"/>
  <img id="Pan" src="img/Pan.png"/>
  <img id="Grenade" src="img/Grenade.png"/>
  <img id="DeathGrenade" src="img/DeathGrenade.png"/>
  <img id="Seeker" src="img/Seeker.png"/>
</div>

    <div class="gameover">
        <div id="msgbox" class="gameover_panel" onclick="$('.gameover').hide(); restart();">
            <ul id="listboard">
            </ul>
        </div>
    </div>
        <!-- Page Wrapper -->
            <div id="page-wrapper">

                <!-- Header -->
                    <header id="header">
                       <h1><a href="index.html">Little Battle</a></h1>
                        <nav id="nav">
                            <ul>
                                <li class="special">
                                    <a href="#menu" class="menuToggle"><span>MENU</span></a>
                                    <div id="menu">
                                        <ul>
                                            <li><a href="index.html">HOME</a></li>
                                            <li><a href="login.html">SIGN IN</a></li>
                                            <li><a href="signup.html">SIGN UP</a></li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </nav>
                    </header>
                </div>
                <div class="left_body">
                        <div id="repo">
                                        <ul id="repo_list">
                                            <li><span>ID</span><span>K/D</span><span>RATE</span></li>

                                        </ul>
                                    </div>                
                        <ul>
                            <li id="controlBtn" class="button info fit">START</li>
                            <li id="clearBtn" class="button info fit">CLEAR</li>
                            <a id="repoBtn" href="#repo" class="button info fit">ADD</a>
                        </ul>
                        <div id="editor">
var tank = {
        //每帧开始时无条件触发
    onEvent : function() {
        this.fire();
    },

        //遇到障碍物时触发，参数dir表示哪一侧有障碍物的方向，
        //例如：dir.u === 1时，代表上方有障碍物，dir.u === 0时即没有
        //dir.d、dir.l、dir.r依次表示下方、左方、右方，
        //最多三个方向同时有障碍物，最少一个方向
    onHitWall : function(dir) {

    },

        //每帧开始时触发，参数enemies为数组，每个元素代表一个敌方玩家的位置和速度，
        //例如：enemies[0]取值为{ pos:{x:300,y:200}, speed:{x:100,y:0} }
        //表示该玩家在(300,200)处，沿着x轴速度为100，y轴速度为0，
        //若想获得该玩家的位置的x分量，即enemies[0].pos.x，
        //该玩家的速度的y分量，即enemies[0].speed.y。
    onEnemySpotted : function(enemies) {

    }

};

                        </div>       
                                 
                </div>
                <div class="right_body">
                    <canvas id="map"></canvas>
                </div>
            </div>

        <section class="wrapper style5">
                            <div class="inner">

                                <section>
                                    <h4>Text</h4>
                                    <p>This is <b>bold</b> and this is <strong>strong</strong>. This is <i>italic</i> and this is <em>emphasized</em>.
                                    This is <sup>superscript</sup> text and this is <sub>subscript</sub> text.
                                    This is <u>underlined</u> and this is code: <code>for (;;) { ... }</code>. Finally, <a href="#">this is a link</a>.</p>
                                    <hr />
                                    <header>
                                        <h4>Heading with a Subtitle</h4>
                                        <p>Lorem ipsum dolor sit amet nullam id egestas urna aliquam</p>
                                    </header>
                                    <p>Nunc lacinia ante nunc ac lobortis. Interdum adipiscing gravida odio porttitor sem non mi integer non faucibus ornare mi ut ante amet placerat aliquet. Volutpat eu sed ante lacinia sapien lorem accumsan varius montes viverra nibh in adipiscing blandit tempus accumsan.</p>
                                    <header>
                                        <h5>Heading with a Subtitle</h5>
                                        <p>Lorem ipsum dolor sit amet nullam id egestas urna aliquam</p>
                                    </header>
                                    <p>Nunc lacinia ante nunc ac lobortis. Interdum adipiscing gravida odio porttitor sem non mi integer non faucibus ornare mi ut ante amet placerat aliquet. Volutpat eu sed ante lacinia sapien lorem accumsan varius montes viverra nibh in adipiscing blandit tempus accumsan.</p>
                                    <hr />
                                    <h2>Heading Level 2</h2>
                                    <h3>Heading Level 3</h3>
                                    <h4>Heading Level 4</h4>
                                    <h5>Heading Level 5</h5>
                                    <h6>Heading Level 6</h6>
                                    <hr />
                                    <h5>Blockquote</h5>
                                    <blockquote>Fringilla nisl. Donec accumsan interdum nisi, quis tincidunt felis sagittis eget tempus euismod. Vestibulum ante ipsum primis in faucibus vestibulum. Blandit adipiscing eu felis iaculis volutpat ac adipiscing accumsan faucibus. Vestibulum ante ipsum primis in faucibus lorem ipsum dolor sit amet nullam adipiscing eu felis.</blockquote>
                                    <h5>Preformatted</h5>
                                    <pre><code>i = 0;

while (!deck.isInOrder()) {
  print 'Iteration ' + i;
  deck.shuffle();
  i++;
}

print 'It took ' + i + ' iterations to sort the deck.';</code></pre>
                                </section>

             

        <script>
            var socket = io.connect();
            if (!localStorage.curUser || localStorage.curUser === "undefined")
                window.location.href = "login.html";

        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.getSession().setMode("ace/mode/javascript");
        editor.setFontSize(14);
        editor.getSession().setOptions({
            tabSize: 4,
            useSoftTabs: true
        });
        editor.getSession().on('change', function(e) {
            window.current_code = editor.getValue();
        });
        </script>

        <script>
            var gameover = function(_stat, _is_failed) {

            let list = document.getElementById("listboard");
            if (_is_failed !== true) {
                let stat = [];
                for (var id in _stat)
                    if (_stat[id] && _stat[id].kill>=0)
                        stat.push([id, _stat[id].kill, _stat[id].death, _stat[id].kill / (_stat[id].death===0 ? 1 : _stat[id].death)]);
                stat.sort((a, b)=>{
                    if (a[3] < b[3])
                        return 1;
                    else if (a[3] > b[3])
                        return -1;
                    else if (a[2] > b[2])
                        return 1;
                    else if (a[2] < b[2])
                        return -1;
                    else if (a[0] > b[0])
                        return 1;
                    else if (a[0] < b[0])
                        return -1;
                    else
                        return 0;
                });

                
                list.innerHTML = "<li><span>Rank</span><span>ID</span><span>K/D</span></li>";

                for (let i = 0; i < stat.length; i++)
                    if (stat[i]!=undefined)
                        list.innerHTML = list.innerHTML + "<li><span>" + (i + 1) + "</span><span>" + stat[i][0] + "</span><span>" + stat[i][1] + "/" + stat[i][2] + "</span></li>";
                socket.emit('update_data', stat);

            }
            else {
                list.innerHTML = "<li>An error ocurred due to " + _stat + "’s fucking code. Competition aborted.</li>";
            }
                $('.gameover').show();   
            };
        </script>



        <script>
        var enviroment = {
                map: document.getElementById('map'),
                ctx: map.getContext('2d')
        };
        core = new Q.core(enviroment,{width:600,height:600},{width:20,height:20},gameover);
        socket.emit("fetch_init_code", localStorage.curUser);
        socket.on('init_code', (code)=>{
            if (code.length > 5)
                editor.setValue(code);
            core.add_player(localStorage.curUser, editor.getValue());
        });
        socket.on('unauthorized', ()=>{
            window.location.href = "login.html";
        });
        
        </script>

    <script>
        $("#repoBtn").on('click', ()=>{
            if (core.competing) {
                alert("中途摇人？不存在的！");
                return;
            }
            let list = document.getElementById('repo_list');
            list.innerHTML = "<li><span>ID</span><span>K/D</span><span>RATE</span></li>";
            if (localStorage.curUser) {
                socket.emit('get_repo');
            }
        });

        socket.on('recv_repo',(results)=>{
            let list = document.getElementById('repo_list');
            for (let i=0; i<results.length; i++)
                if (results[i]) {
                    list.innerHTML = list.innerHTML + "<li><span>" +
                        results[i].id + "</span><span>" +
                        results[i].num_kill + "/" +
                        results[i].num_death + "</span><span>RATE</span><span class='join' id='joinBtn_" + i + "' onclick='socket.emit(&apos;fetch_code&apos;,&apos;"  + results[i].id + "&apos;);'>Join</span></li>";
                }
        });

        socket.on('recv_code', (user)=>{
            core.add_player(user.id, user.code);
        });
    </script>
    <script>
        var controlBtn = document.getElementById("controlBtn");
        var restart = function() {
            window.current_code = editor.getValue();

            core.init(enviroment,{width:600,height:600},{width:20,height:20},gameover);
            core.add_player(localStorage.curUser, window.current_code);

            socket.emit("update_code", {id:localStorage.curUser, code:window.current_code});

            $("#repoBtn").attr("href","#repo");
            controlBtn.innerHTML = "START";
        };
        $("#clearBtn").on('click', restart);
        
        $("#controlBtn").on('click', ()=>{
            if (core.finished) return;
            if (core.running) {
                core.running = false;
                controlBtn.innerHTML = "START";
            }
            else {
                if (core.player_count <= 1) {
                    alert('摇点人吧！一人太孤单了');
                    return;
                }
                core.running = true;
                core.competing = true;
                $("#repoBtn").removeAttr("href");
                controlBtn.innerHTML = "PAUSE";
                socket.emit("update_code", {id:localStorage.curUser, code:window.current_code});        
            }
        });
    </script>

</body>
</html>