<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<head>

    <title>Little Battle</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="style/main.css" rel="stylesheet">
    <link href="style/repo.css" rel="stylesheet">
    <link href="style/game.css" rel="stylesheet">

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/ace/1.2.6/ace.js"></script>
    <script src="lib/jquery.scrollex.min.js"></script>
    <script src="lib/jquery.scrolly.min.js"></script>
    <script src="lib/skel.min.js"></script>
    <script src="lib/util.js"></script>
    <script src="lib/main.js"></script>
    <script src="lib/quisus.js"></script>
    <script src="core.js"></script>
    <script src="renderer.js"></script>
        
</head>

  <body>
    <div class="weapon">
    <img id="UMP9" src="img/UMP9.png"/>
  <img id="Micro_Uzi" src="img/Micro_Uzi.png"/>
  <img id="Vector" src="img/Vector.png"/>
  <img id="AKM" src="img/AKM.png"/>
  <img id="Groza" src="img/Groza.png"/>
  <img id="M16A4" src="img/M16A4.png"/>
  <img id="Scar-L" src="img/Scar-L.png"/>
  <img id="M416" src="img/M416.png"/>
  <img id="Kar-98K" src="img/Kar-98K.png"/>
  <img id="M24" src="img/M24.png"/>
  <img id="SKS" src="img/SKS.png"/>
  <img id="AWM" src="img/AWM.png"/>
  <img id="MK14" src="img/MK14.png"/>
  <img id="M249" src="img/M249.png"/>
  <img id="Minigun" src="img/Minigun.png"/>
  <img id="Dominator-77" src="img/Dominator-77.png"/>
  <img id="PF-89" src="img/PF-89.png"/>
  <img id="S1897" src="img/S1897.png"/>
  <img id="S686" src="img/S686.png"/>
  <img id="Pan" src="img/Pan.png"/>
  <img id="Grenade" src="img/Grenade.png"/>
  <img id="DeathGrenade" src="img/DeathGrenade.png"/>
  <img id="Seeker" src="img/Seeker.png"/>
</div>

    <div class="gameover">
        <div id="msgbox" class="gameover_panel" onclick="$('.gameover').hide()">
            <ul id="listboard">
            </ul>
        </div>
    </div>
        <!-- Page Wrapper -->
            <div id="page-wrapper">

                <!-- Header -->
                    <header id="header">
                       <h1><a href="index.html">Little Battle</a></h1>
                        <nav id="nav">
                            <ul>
                                <li class="special">
                                    <a href="#menu" class="menuToggle"><span>MENU</span></a>
                                    <div id="menu">
                                        <ul>
                                            <li><a href="index.html">HOME</a></li>
                                            <li><a href="login.html">SIGN IN</a></li>
                                            <li><a href="signup.html">SIGN UP</a></li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </nav>
                    </header>
                </div>
                <div class="left_body">
                        <div id="repo">
                                        <ul id="repo_list">
                                            <li><span>ID</span><span>K/D</span><span>RATE</span></li>

                                        </ul>
                                    </div>                
                        <ul>
                            <li id="controlBtn" class="button info fit">START</li>
                            <li id="clearBtn" class="button info fit">CLEAR</li>
                            <a id="repoBtn" href="#repo" class="button info fit">ADD</a>
                        </ul>
                        <div id="editor">
var tank = {
        //每帧开始时无条件触发
    onEvent : function() {
        this.fire();
    },

    onHitWall : function() {

    },

    onHitByBullet : function() {

    }
};

                        </div>
                            
                                 
                </div>
                <div class="right_body">
                    <canvas id="map"></canvas>
                </div>
            </div>
             

        <script>
            var socket = io.connect();
            if (!localStorage.curUser || localStorage.curUser === "undefined")
                window.location.href = "login.html";

        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.getSession().setMode("ace/mode/javascript");
        editor.setFontSize(14);
        editor.getSession().setOptions({
            tabSize: 4,
            useSoftTabs: true
        });
        editor.getSession().on('change', function(e) {
            window.current_code = editor.getValue();
        });
        </script>

        <script>
            var gameover = function(_stat) {
                let stat = [];
                for (var id in _stat)
                    if (_stat[id] && _stat[id].kill>=0)
                        stat.push([id, kill, death, kill / (death===0 ? 1 : death)]);
                stat.sort((a, b)=>{
                    if (a[3] < b[3])
                        return 1;
                    else if (a[3] > b[3])
                        return -1;
                    else if (a[2] > b[2])
                        return 1;
                    else if (a[2] < b[2])
                        return -1;
                    else if (a[0] > b[0])
                        return 1;
                    else if (a[0] < b[0])
                        return -1;
                    else
                        return 0;
                });

                let list = document.getElementById("listboard");
                list.innerHTML = "<li><span>Rank</span><span>ID</span><span>K/D</span></li>";

                for (let i = 0; i < stat.length; i++)
                    if (stat[i]!=undefined)
                        list.innerHTML = list.innerHTML + "<li><span>" + (i + 1) + "</span><span>" + stat[i][0] + "</span><span>" + stat[i][1] + "/" + stat[i][2] + "</span></li>";
                $('.gameover').show();

                socket.emit('update_data', stat);
            };
        </script>



        <script>
        var enviroment = {
                map: document.getElementById('map'),
                ctx: map.getContext('2d')
        };
        core = new Q.core(enviroment,{width:600,height:600},{width:20,height:20},gameover);
        socket.emit("fetch_code", localStorage.curUser);
        socket.on('recv_code', (user)=>{
            if (user.id === localStorage.curUser && user.code.length > 10)
                editor.setValue(user.code);
            core.add_player(user.id, window.current_code);
        });
        socket.on('unauthorized', ()=>{
            window.location.href = "login.html";
        });
        
        </script>

    <script>
        $("#repoBtn").on('click', ()=>{
            if (core.competing) {
                alert("中途摇人？不存在的！");
                return;
            }
            let list = document.getElementById('repo_list');
            list.innerHTML = "<li><span>ID</span><span>K/D</span><span>RATE</span></li>";
            if (localStorage.curUser) {
                socket.emit('get_repo');
            }
        });

        socket.on('recv_repo',(results)=>{
            let list = document.getElementById('repo_list');
            for (let i=0; i<results.length; i++)
                if (results[i]) {
                    list.innerHTML = list.innerHTML + "<li><span>" +
                        results[i].id + "</span><span>" +
                        results[i].num_kill + "/" +
                        results[i].num_death + "</span><span>RATE</span><span class='join' id='joinBtn_" + i + "' onclick='socket.emit(&apos;fetch_code&apos;,&apos;"  + results[i].id + "&apos;);'>Join</span></li>";
                }
        });
    </script>
    <script>
        var controlBtn = document.getElementById("controlBtn");
        $("#clearBtn").on('click', ()=>{

            window.current_code = editor.getValue();

            core.init(enviroment,{width:600,height:600},{width:20,height:20},gameover);
            core.add_player(localStorage.curUser, window.current_code);

            socket.emit("update_code", {id:localStorage.curUser, code:window.current_code});

            $("#repoBtn").attr("href","#repo");
            controlBtn.innerHTML = "START";
        });
        
        $("#controlBtn").on('click', ()=>{
            if (core.finished) return;
            if (core.running) {
                core.running = false;
                controlBtn.innerHTML = "START";
            }
            else {
                if (core.player_count <= 1) {
                    alert('就一个人，对墙撸吗？');
                    return;
                }
                core.running = true;
                core.competing = true;
                $("#repoBtn").removeAttr("href");
                controlBtn.innerHTML = "PAUSE";
                socket.emit("update_code", {id:localStorage.curUser, code:window.current_code});        
            }
        });
    </script>

</body>
</html>