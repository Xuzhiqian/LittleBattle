<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<head>

    <title>Little Battle</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="style/main.css" rel="stylesheet">
    <link href="style/repo.css" rel="stylesheet">
    <link href="style/game.css" rel="stylesheet">

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/ace/1.2.6/ace.js"></script>
    <script src="lib/jquery.scrollex.min.js"></script>
    <script src="lib/jquery.scrolly.min.js"></script>
    <script src="lib/skel.min.js"></script>
    <script src="lib/util.js"></script>
    <script src="lib/main.js"></script>
    <script src="lib/quisus.js"></script>
    <script src="core.js"></script>
    <script src="renderer.js"></script>
        
</head>

  <body>
    <div class="weapon">
    <img id="UMP9" src="img/UMP9.png"/>
  <img id="Micro_Uzi" src="img/Micro_Uzi.png"/>
  <img id="Vector" src="img/Vector.png"/>
  <img id="AKM" src="img/AKM.png"/>
  <img id="Groza" src="img/Groza.png"/>
  <img id="M16A4" src="img/M16A4.png"/>
  <img id="Scar-L" src="img/Scar-L.png"/>
  <img id="M416" src="img/M416.png"/>
  <img id="Kar-98K" src="img/Kar-98K.png"/>
  <img id="M24" src="img/M24.png"/>
  <img id="SKS" src="img/SKS.png"/>
  <img id="AWM" src="img/AWM.png"/>
  <img id="MK14" src="img/MK14.png"/>
  <img id="M249" src="img/M249.png"/>
  <img id="Minigun" src="img/Minigun.png"/>
  <img id="Dominator-77" src="img/Dominator-77.png"/>
  <img id="PF-89" src="img/PF-89.png"/>
  <img id="S1897" src="img/S1897.png"/>
  <img id="S686" src="img/S686.png"/>
  <img id="Pan" src="img/Pan.png"/>
  <img id="Grenade" src="img/Grenade.png"/>
  <img id="DeathGrenade" src="img/DeathGrenade.png"/>
  <img id="Seeker" src="img/Seeker.png"/>
  <img id="jet" src="img/jet.png"/>
  <img id="gravity" src="img/gravity.png"/>
  <img id="bounce" src="img/bounce.png"/>
  <img id="heal" src="img/heal.png"/>
  <img id="invisible" src="img/invisible.png"/>
  <img id="clone" src="img/clone.png"/>
</div>

    <div class="gameover">
        <div id="msgbox" class="gameover_panel" onclick="$('.gameover').hide(); restart();">
            <ul id="listboard">
            </ul>
        </div>
    </div>
        <!-- Page Wrapper -->
            <div id="page-wrapper">

                <!-- Header -->
                    <header id="header">
                       <h1><a href="index.html">Little Battle</a></h1>
                        <nav id="nav">
                            <ul>
                                <li class="special">
                                    <a href="#menu" class="menuToggle"><span>MENU</span></a>
                                    <div id="menu">
                                        <ul>
                                            <li><a href="index.html">HOME</a></li>
                                            <li><a href="login.html">SIGN IN</a></li>
                                            <li><a href="signup.html">SIGN UP</a></li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </nav>
                    </header>
                </div>
                <div class="left_body">
                        <div id="repo">
                                        <ul id="repo_list">
                                            <li><span>ID</span><span>K/D</span><span>RATE</span><span>SCORE</span</li>

                                        </ul>
                                    </div>                
                        <ul>
                            <li id="controlBtn" class="button info fit">START</li>
                            <li id="againBtn" class="button info fit">AGAIN</li>
                            <li id="clearBtn" class="button info fit">CLEAR</li>
                            <a id="repoBtn" href="#repo" class="button info fit">ADD</a>
                            <li id="autoBtn" class="button info fit" style="float:right">AUTO</li>
                            
                        </ul>
                        <div id="editor">

var tank = {
	character : 'normal',
    onEvent : function() {
        
    },

    onHitWall : function(dir) {

    },

    onEnemySpotted : function(enemies) {

    },

    onWeaponSpotted : function(weapons) {

    }

};
                    </div>       
                                 
                </div>
                <div class="right_body">
                    <canvas id="map"></canvas>
                </div>
            </div>
             <section class="wrapper style5">
                    <div class="inner">
                        <br><br><br><br><br><br><br><br><br><br><br><br>
                        <br><br><br><br><br><br>
    <h2>流程</h2>
    <p>游戏某一帧开始-->检测事件是否触发-->触发事件，执行玩家代码-->引擎计算速度和位置，发射子弹-->该帧结束</p>

    <h2>事件</h2>
    <ul>
        <li>onEvent
            <h4>示例</h4>
    
            <pre><code>onEvent : function() {
    this.fire();
}</code></pre>

            <p>每帧开始时无条件触发</p>
        </li>
        <li>onHitWall
            <h4>示例</h4>
    
            <pre><code>onHitWall : function(dir) {
    if (dir.u === 1)
        this.moveRight();
}</code></pre>

            <p>遇到障碍物（包括边界）时触发，参数dir表示哪一侧有障碍物的方向。<br>例如：dir.u === 1时，代表上方有障碍物，dir.u === 0时即上方没有障碍物，dir.d、dir.l、dir.r依次表示下方、左方、右方。<br>最多三个方向同时有障碍物，最少一个方向。</p>
        </li>
        <li>onEnemySpotted
            <h4>示例</h4>
    
            <pre><code>onEnemySpotted : function(enemies) {
    //enemies[0]表示enemies数组中的第一个玩家
    //获取enemies数组长度：enemies.length
    //获取第一个玩家的属性：
    //位置：enemies[0].pos.x和enemies[0].pos.y
    //速度：enemies[0].speed.x和enemies[0].speed.y
    //血量：enemies[0].health
}</code></pre>

            <p>有其他玩家存活并且可见时触发，enemies数组包含了所有这些存活且可见的玩家。</p>
        </li>
        <li>onWeaponSpotted
            <h4>示例</h4>
    
            <pre><code>onWeaponSpotted : function(weapons) {
    //weapons[0]表示weapons数组中的第一个武器
    //获取weapons数组长度：weapons.length
    //获取第一个武器的属性：
    //位置：weapons[0].pos.x和weapons[0].pos.y
    //名称：weapons[0].id
}</code></pre>

            <p>场上有可被拾取的武器时触发</p>
        </li>
        <li>onToolSpotted
            <h4>示例</h4>
    
            <pre><code>onToolSpotted : function(tools) {
    //tools[0]表示tools数组中的第一个道具
    //获取tools数组长度：tools.length
    //获取第一个道具的属性：
    //位置：tools[0].pos.x和tools[0].pos.y
    //名称：tools[0].id
}</code></pre>

            <p>场上有可被拾取的道具时触发</p>
        </li>
    </ul>

            <h2>可调用的方法</h2>
            <div class="table-wrapper">
                        <table class="alt">
                                            <thead>
                                                <tr>
                                                    <th>调用方式</th>
                                                    <th>描述</th>
                                                    <th>参数意义</th>
                                                    <th>参数取值</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>this.moveUp(pri)</td>
                                                    <td>向上加速</td>
                                                    <td>优先级</td>
                                                    <td>0-5，默认为0</td>
                                                </tr>
                                                <tr>
                                                    <td>this.moveDown(pri)</td>
                                                    <td>向下加速</td>
                                                    <td>优先级</td>
                                                    <td>0-5，默认为0</td>
                                                </tr>
                                                <tr>
                                                    <td>this.moveLeft(pri)</td>
                                                    <td>向左加速</td>
                                                    <td>优先级</td>
                                                    <td>0-5，默认为0</td>
                                                </tr>
                                                <tr>
                                                    <td>this.moveRight(pri)</td>
                                                    <td>向右加速</td>
                                                    <td>优先级</td>
                                                    <td>0-5，默认为0</td>
                                                </tr>
                                                <tr>
                                                    <td>this.fire()</td>
                                                    <td>射击</td>
                                                    <td></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td>this.pick()</td>
                                                    <td>捡起周围的武器</td>
                                                    <td></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td>this.skill(arguments)</td>
                                                    <td>使用特定的技能</td>
                                                    <td>取决于特定技能而定</td>
                                                    <td>取决于特定技能</td>
                                                </tr>
                                                <tr>
                                                    <td>this.say(msg)</td>
                                                    <td>游戏中显示信息</td>
                                                    <td>你想要发送的信息</td>
                                                    <td>数字或字符串</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
            <h2>属性</h2>
            <div class="table-wrapper">
                        <table class="alt">
                                            <thead>
                                                <tr>
                                                    <th>语句</th>
                                                    <th>描述</th>
                                                    <th>单位</th>
                                                    <th>是否可被修改</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>this.x</td>
                                                    <td>当前x轴坐标</td>
                                                    <td>像素</td>
                                                    <td>否</td>
                                                </tr>
                                                <tr>
                                                    <td>this.y</td>
                                                    <td>当前y轴坐标</td>
                                                    <td>像素</td>
                                                    <td>否</td>
                                                </tr>
                                                <tr>
                                                    <td>this.speed.x</td>
                                                    <td>当前速度x分量</td>
                                                    <td>像素/秒</td>
                                                    <td>否</td>
                                                </tr>
                                                <tr>
                                                    <td>this.speed.y</td>
                                                    <td>当前速度y分量</td>
                                                    <td>像素/秒</td>
                                                    <td>否</td>
                                                </tr>
                                                <tr>
                                                    <td>this.acc.x</td>
                                                    <td>x方向加速度</td>
                                                    <td>像素/秒/秒</td>
                                                    <td>否</td>
                                                </tr>
                                                <tr>
                                                    <td>this.acc.y</td>
                                                    <td>y方向加速度</td>
                                                    <td>像素/秒/秒</td>
                                                    <td>否</td>
                                                </tr>
                                                <tr>
                                                    <td>this.dir</td>
                                                    <td>当前射击方向</td>
                                                    <td>弧度</td>
                                                    <td>是</td>
                                                </tr>
                                                <tr>
                                                    <td>this.bullet_speed</td>
                                                    <td>当前子弹速度</td>
                                                    <td>像素/秒</td>
                                                    <td>否</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
        <h2>人物</h2>
        <ul>
        	<li>
        		<h4>刺客</h4>
        		<p>定义：character : 'assassin'</p>
        		<p>技能：隐身一段时间，调用方法：this.skill()</p>
        	</li>
        	<li>
        		<h4>战士</h4>
        		<p>定义：character : 'worrior'</p>
        		<p>被动技能，以一定的几率反弹子弹，血量越低，几率越大</p>
        	</li>
        	<li>
        		<h4>法师</h4>
        		<p>定义：character : 'sorcerer'</p>
        		<p>技能：传送至指定位置，调用方法：this.skill(x, y)，其中x、y为位置坐标</p>
        	</li>
        </ul>
        <h2>游戏参数</h2>
        <div class="table-wrapper">
            <table>
                                            <thead>
                                                <tr>
                                                    <th>参数</th>
                                                    <th>值</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>逻辑/渲染帧率</td>
                                                    <td>60FPS</td>
                                                </tr>
                                                <tr>
                                                    <td>地图大小</td>
                                                    <td>600px*600px</td>
                                                </tr>
                                                <tr>
                                                    <td>坦克半径</td>
                                                    <td>15px</td>
                                                </tr>
                                                <tr>
                                                    <td>坦克最高速度</td>
                                                    <td>120px/s</td>
                                                </tr>
                                                <tr>
                                                    <td>坦克加速度</td>
                                                    <td>180px/(s*s)</td>
                                                </tr>
                                                <tr>
                                                    <td>坦克粘滞阻力</td>
                                                    <td>-180px/(s*s)</td>
                                                </tr>
                                                <tr>
                                                    <td>子弹速度</td>
                                                    <td>240px/s</td>
                                                </tr>
                                                <tr>
                                                    <td>子弹半径</td>
                                                    <td>5px</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
</div>
</section>
        <script>
            var socket = io.connect();
            if (!localStorage.curUser || localStorage.curUser === "undefined")
                window.location.href = "login.html";

        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.getSession().setMode("ace/mode/javascript");
        editor.setFontSize(14);
        editor.getSession().setOptions({
            tabSize: 4,
            useSoftTabs: true
        });
        editor.getSession().on('change', function(e) {
            window.current_code = editor.getValue();
        });
        </script>

        <script>
            var gameover = function(_stat, _is_failed) {

            let list = document.getElementById("listboard");
            if (_is_failed !== true) {
                let stat = [];
                for (var id in _stat)
                    if (_stat[id] && _stat[id].kill>=0)
                        stat.push([id, _stat[id].kill, _stat[id].death, _stat[id].kill / (_stat[id].death===0 ? 1 : _stat[id].death), _stat[id].d_score, Math.round(_stat[id].output)]);
                stat.sort((a, b)=>{
                	if (a[4] < b[4])
                		return 1;
                	else if (a[4] > b[4])
                		return -1;
                	else if (a[5] < b[5])
                		return 1;
                	else if (a[5] > b[5])
                		return -1;
                    else if (a[3] < b[3])
                        return 1;
                    else if (a[3] > b[3])
                        return -1;
                    else if (a[2] > b[2])
                        return 1;
                    else if (a[2] < b[2])
                        return -1;
                    else if (a[0] > b[0])
                        return 1;
                    else if (a[0] < b[0])
                        return -1;
                    else
                        return 0;
                });

                
                list.innerHTML = "<li><span>Rank</span><span>ID</span><span>K/D</span><span>OUTPUT</span><span>SCORE</span></li>";

                for (let i = 0; i < stat.length; i++)
                    if (stat[i]!=undefined)
                        list.innerHTML = list.innerHTML + "<li><span>" + (i + 1) + "</span><span>" + stat[i][0] + "</span><span>" + stat[i][1] + "/" + stat[i][2] + "</span><span>" + stat[i][5] + "</span><span>" + (stat[i][4]>0?'+':'') + stat[i][4] + "</span></li>";
                socket.emit('update_data', stat);

            }
            else {
                list.innerHTML = "<li>An error ocurred due to " + _stat + "’s fucking code. Competition aborted.</li>";
            }
            	if (!auto_game)
                	$('.gameover').show();
                else {
                	$("#againBtn").click();
                	setTimeout(()=>{$("#controlBtn").click()}, 5000);
                }
            };
        </script>



        <script>
        var my_score = 1000;
        var enviroment = {
                map: document.getElementById('map'),
                ctx: map.getContext('2d')
        };
        core = new Q.core(enviroment,{width:600,height:600},{width:20,height:20},gameover);
        socket.emit("fetch_init_code", localStorage.curUser);
        socket.on('init_code', (result)=>{
            if (result.code.length > 5)
                editor.setValue(result.code);
            core.add_player(localStorage.curUser, editor.getValue(), result.score);
            my_score = result.score;
        });
        socket.on('unauthorized', ()=>{
            window.location.href = "login.html";
        });
        
        </script>

    <script>
        $("#repoBtn").on('click', ()=>{
            if (core.competing) {
                alert("中途摇人？不存在的！");
                return;
            }
            let list = document.getElementById('repo_list');
            list.innerHTML = "<li><span>ID</span><span>K/D</span><span>RATE</span><span>SCORE</span><span class='join' onclick='socket.emit(&apos;fetch_all_code&apos;)'>All</span></li>";
            if (localStorage.curUser) {
                socket.emit('get_repo');
            }
        });

        socket.on('recv_repo',(results)=>{
            let list = document.getElementById('repo_list');

            for (let i=0; i<results.length; i++)
                results[i].rate = results[i].num_kill / (results[i].num_death === 0 ? 1 : results[i].num_death);
            results.sort((a, b)=>{
            		if (a.num_kill === 0 && b.num_kill > 0)
            			return 1;
            		else if (a.num_kill > 0 && b.num_kill === 0)
            			return -1;
            		else if (a.score < b.score)
            			return 1;
                    else if (a.score > b.score)
                    	return -1;
                    else if (a.rate < b.rate)
                        return 1;
                    else if (a.rate > b.rate)
                        return -1;
                    else if (a.num_death > b.num_death)
                        return 1;
                    else if (a.num_death < b.num_death)
                        return -1;
                    else if (a.id > b.id)
                        return 1;
                    else if (a.id < b.id)
                        return -1;
                    else
                        return 0;
                });
            for (let i=0; i<results.length; i++)
                if (results[i]) {
                    list.innerHTML = list.innerHTML + "<li><span>" +
                        results[i].id + "</span><span>" +
                        results[i].num_kill + "/" +
                        results[i].num_death + "</span><span>" +  
                        results[i].rate.toFixed(3) + "</span><span>" +
                        results[i].score + "</span><span class='join' id='joinBtn_" + i + "' onclick='socket.emit(&apos;fetch_code&apos;,&apos;"  + results[i].id + "&apos;);'>Join</span></li>";
                }
        });

        socket.on('recv_code', (user)=>{
            core.add_player(user.id, user.code, user.score);
        });
        socket.on('recv_all_code', (results)=>{
            for (let i=0;i<results.length;i++)
                core.add_player(results[i].id, results[i].code, results[i].score, true);
        });
    </script>
    <script>
    	var last_players = [];
        var controlBtn = document.getElementById("controlBtn");
        var autoBtn = document.getElementById("autoBtn");
        var auto_game = false;
        var restart = function() {
        	if (core.competing) {
        		alert('别当逃兵哦！');
        		return;
        	}
            window.current_code = editor.getValue();

            core.init(enviroment,{width:600,height:600},{width:20,height:20},gameover);
            core.add_player(localStorage.curUser, window.current_code, my_score);

            socket.emit("update_code", {id:localStorage.curUser, code:window.current_code});

            $("#repoBtn").attr("href","#repo");
            controlBtn.innerHTML = "START";
        };
        $("#clearBtn").on('click', restart);
        
        $("#controlBtn").on('click', ()=>{
            if (core.finished) return;
            if (core.running) {
                core.running = false;
                controlBtn.innerHTML = "START";
            }
            else {
                if (core.player_count <= 1) {
                    alert('摇点人吧！一人太孤单了');
                    return;
                }
                core.running = true;
                core.competing = true;
                last_players = core.get_players();
                $("#repoBtn").removeAttr("href");
                controlBtn.innerHTML = "PAUSE";
                socket.emit("update_code", {id:localStorage.curUser, code:window.current_code});        
            }
        });
        $("#againBtn").on('click', ()=>{
        	if (core.competing) {
        		alert('别当逃兵哦！');
        		return;
        	}
        	restart();
        	last_players.forEach((id)=>{
        		socket.emit('fetch_code', id);
        	});
        });
        $("#autoBtn").on('click', ()=>{
        	if (auto_game === true) {
        		auto_game = false;
        		autoBtn.innerHTML = "AUTO";
        	}
        	else {
        		auto_game = true;
        		autoBtn.innerHTML = "MANUAL";
        	}
        });
    </script>

</body>
</html>